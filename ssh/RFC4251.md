# SSH 协议架构

## 简介

SSH 由 3 个主要部分组成:

1.**传输层协议**(Transport Layer Protocol,SSH-TRANS)

提供服务器身份验证、机密性和完整性,还提供压缩(可选项),
传输层通常运行于 TCP/IP 连接之上，但也可以在其他运行与任何可靠的数据流之上.

> 大部分 SSH 实现都是基于 TCP, 但是可以基本 UDP(例如 [mosh](https://mosh.org/) 等)

2.**用户认证协议**(User Authentication Protocol,SSH-USERAUTH)

认证连接服务端的客户端用户,它是运行在`传输层协议协`之上的协议。


3.**连接协议**(Connection Protocol,SSH-CONNECT)

复用加密的隧道(tunnel)为几个逻辑通道(channel)。它是运行在`用户认证协议`之上的协议。


一旦建立了安全传输层连接，客户端就会发送服务请求。
用户身份验证完成后发送第二个服务请求。
这允许定义新协议并与上面列出的协议共存。


连接协议提供了用途广泛的通道。
最常用的是提供用于设置安全交互式 shell 会话和转发任意 TCP/IP 端口和 X11(X Window System, 图形界面) 连接。

----

## 架构

### 主机密钥

每个服务器主机都应该有一个主机密钥。 主机可能有多个使用多种不同算法的主机密钥。
多个主机可以共享同一个主机密钥。
如果主机有密钥，它必须至少有一个使用每个必需的公钥算法的密钥。

在密钥交换期间使用服务器主机密钥来验证客户端是否真的在与正确的服务器通信。
为此，客户端必须先验地了解服务器的公共主机密钥。



可以使用两种不同的信任模型：

客户端有一个本地数据库，它将每个主机名（由用户键入）与相应的公共主机密钥相关联。
这种方法不需要集中管理的基础设施，也不需要第三方协调。
缺点是名称到键关联的数据库可能会变得难以维护。

主机名-密钥关联由受信任的证书颁发机构(CA)认证。
客户端只知道 CA 根密钥，并且可以验证所有被接受的 CA 认证的主机密钥的有效性。

第二种选择减轻了维护问题，因为理想情况下，只需将单个 CA 密钥安全地存储在客户端上。
另一方面，在授权之前，每个主机密钥都必须经过中央机构的适当认证。
此外，对中央基础设施也有很大的信任。

该协议提供了第一次连接主机时不检查服务器名称-主机密钥关联的选项。 
这允许在没有主机密钥或证书的事先通信的情况下进行通信。
该连接仍然可以防止被动收听； 但是，它很容易受到主动的中间人攻击。
默认情况下，实现通常不应允许此类连接，因为它们会带来潜在的安全问题。
但是，由于在撰写本文时 Internet 上还没有广泛部署的关键基础设施，
因此此选项使协议在过渡期间更加可用，直到此类基础设施出现，
同时仍提供比之前更高级别的安全性由较旧的解决方案提供（例如，telnet [RFC0854] 和 rlogin [RFC1282]）。


实现应该尽最大努力检查主机密钥。一个可能的策略示例是只接受主机密钥而不检查第一次连接主机时，将密钥保存在本地数据库中，然后在与该主机的所有未来连接上与该密钥进行比较。
实现可以提供额外的方法来验证主机密钥的正确性，例如，从公钥的 SHA-1 哈希派生的十六进制指纹。
通过使用电话或其他外部通信渠道，可以轻松验证此类指纹。
所有实现都应该提供一个选项，不接受无法验证的主机密钥。
该工作组的成员认为，“易用性”对于最终用户接受安全解决方案至关重要，
如果不使用新解决方案，安全性不会得到改善。
因此，提供不检查服务器主机密钥的选项被认为可以提高 Internet 的整体安全性，
即使它在允许的配置中降低了协议的安全性。

### 扩展性

我们相信该协议会随着时间的推移而发展，一些组织将希望使用他们自己的加密、身份验证和/或密钥交换方法。
所有扩展的集中注册很麻烦，特别是对于实验或分类功能。
另一方面，没有中央注册会导致方法标识符冲突，使互操作性变得困难。

我们选择使用特定格式的文本名称来识别算法、方法、格式和扩展协议。
DNS 名称用于创建本地命名空间，可以在其中定义实验性或分类扩展，而不必担心与其他实现发生冲突。

一个设计目标是保持基本协议尽可能简单，并且需要尽可能少的算法。
然而，所有实现必须支持最小的算法集以确保互操作性（这并不意味着所有主机上的本地策略都必须允许这些算法）。
强制性算法在相关协议文档中指定。

其他算法、方法、格式和扩展协议可以在单独的文档中定义。有关详细信息，请参阅第 6 节，算法命名。


### 政策问题

该协议允许对加密、完整性、密钥交换、压缩以及公钥算法和格式进行全面协商。
每个方向的加密、完整性、公钥和压缩算法都可以不同。

在每个实现的配置机制中应该解决以下策略问题：

加密、完整性和压缩算法，分别针对每个方向。策略必须指定首选算法（例如，每个类别中列出的第一个算法）。

用于主机认证的公钥算法和密钥交换方法。不同公钥算法的可信主机密钥的存在也会影响这种选择。

服务器对每个用户要求的身份验证方法。服务器的策略可能需要对部分或所有用户进行多重身份验证。所需的算法可能取决于用户尝试访问的位置。

允许用户使用连接协议执行的操作。有些问题与安全有关；例如，策略不应允许服务器在客户端机器上启动会话或运行命令，并且不得允许连接到身份验证代理，除非已请求转发此类连接。其他问题，例如可以转发哪些 TCP/IP 端口以及由谁转发，显然是本地策略的问题。其中许多问题可能涉及穿越或绕过防火墙，并且与本地安全策略相关。

### 安全属性

SSH 协议的主要目标是提高 Internet 的安全性。
它试图以一种易于部署的方式做到这一点，即使以绝对安全为代价。

使用的所有加密、完整性和公钥算法都是众所周知的、成熟的算法。

所有算法都与密码学上合理的密钥大小一起使用，这些密钥大小被认为可以针对数十年来最强大的密码分析攻击提供保护。

所有算法都是协商的，万一某个算法坏了，不用修改基础协议就可以很容易地切换到其他算法。

做出了特定的让步，以使广泛、快速的部署更容易。 出现这种情况的特殊情况是验证服务器主机密钥是否确实属于所需的主机； 该协议允许忽略验证，但不建议这样做。 这被认为会在短期内显着提高可用性，直到出现广泛的互联网公钥基础设施。


### 本地化和字符集支持

在大多数情况下，SSH 协议不会直接传递将显示给用户的文本。
但是，有些地方可能会传递此类数据。适用时，必须明确指定数据的字符集。
在大多数地方，使用 ISO-10646 UTF-8 编码 [RFC3629]。
如果适用，还为语言标签 [RFC3066] 提供一个字段。

一个大问题是交互式会话的字符集。
没有明确的解决方案，因为不同的应用程序可能以不同的格式显示数据。
客户端也可以采用不同类型的终端仿真，所使用的字符集由终端仿真有效地确定。因此，没有提供直接指定终端会话数据的字符集或编码的地方。但是，终端仿真类型（例如，“vt100”）被传输到远程站点，它隐含地指定了字符集和编码。应用程序通常使用终端类型来确定它们使用的字符集，或者使用某些外部方式确定字符集。终端仿真还可以允许配置默认字符集。在任何情况下，终端会话的字符集主要被认为是客户端本地问题。

用于识别算法或协议的内部名称通常不会向用户显示，并且必须使用 US-ASCII。

客户端和服务器用户名本质上受服务器准备接受的内容的限制。
但是，它们可能偶尔会显示在日志、报告等中。
它们必须使用 ISO 10646 UTF-8 进行编码，但在某些情况下可能需要其他编码。
由服务器决定如何将用户名映射到接受的用户名。建议直接按位进行二进制比较。

出于本地化目的，该协议试图最小化传输的文本消息的数量。
当存在时，此类消息通常与错误、调试信息或某些外部配置的数据相关。
对于正常显示的数据，应该可以通过使用数字代码来获取本地化消息而不是传输的消息。剩余的消息应该是可配置的。

-----

## SSH 协议中使用的数据类型表示


byte

一个字节代表一个任意的 8 位值（八位字节）。 
固定长度数据有时表示为字节数组，写为 byte[n]，其中 n 是数组中的字节数。

boolean

布尔值存储为单个字节。 值 0 表示 FALSE，值 1 表示 TRUE。
所有非零值必须被解释为 TRUE； 但是，应用程序必须不存储 0 和 1 以外的值。

uint32

表示一个 32 位无符号整数。按重要性递减的顺序（网络字节顺序）存储为四个字节。例如：值 699921578 (0x29b7f4aa) 存储为 29 b7 f4 aa。

uint64

表示一个 64 位无符号整数。按重要性递减的顺序（网络字节顺序）存储为 8 个字节。

string

任意长度的二进制字符串。字符串允许包含任意二进制数据，包括空字符和 8 位字符。它们存储为一个 uint32，包含它的长度（后面的字节数）和零（= 空字符串）或更多字节，它们是字符串的值。不使用终止空字符。
字符串也用于存储文本。在这种情况下，US-ASCII 用于内部名称，ISO-10646 UTF-8 用于可能显示给用户的文本。终止的空字符通常不应该存储在字符串中。例如：US-ASCII 字符串“testing”表示为 00 00 00 07 t e s t i n g。 UTF-8 映射不会改变 US-ASCII 字符的编码。

mpint

以二进制补码格式表示多个精度整数，存储为字符串，每字节 8 位，MSB 在前。负数的值 1 作为数据分区第一个字节的最高有效位。如果要为正数设置最高有效位，则该数字必须以零字节开头。不得包含值为 0 或 255 的不必要的前导字节。零值必须存储为具有零字节数据的字符串。
按照惯例，在 Z_n 中的模计算中使用的数字应该在 0 <= x < n 的范围内表示。

例子:

```txt
value (hex)        representation (hex)
-----------        --------------------
0                  00 00 00 00
9a378f9b2e332a7    00 00 00 08 09 a3 78 f9 b2 e3 32 a7
80                 00 00 00 02 00 80
-1234              00 00 00 02 ed cc
-deadbeef          00 00 00 05 ff 21 52 41 11
```

name-list

包含以逗号分隔的名称列表的字符串。 名称列表表示为 uint32，其中包含其长度（后面的字节数），后跟以逗号分隔的零个或多个名称列表。 名称必须具有非零长度，并且不得包含逗号 (",")。 由于这是一个名称列表，因此包含的所有元素都是名称，并且必须是 US-ASCII。 上下文可能会对名称施加额外的限制。 例如，名称列表中的名称可能必须是有效算法标识符的列表（参见下面的第 6 节），或 [RFC3066] 语言标签的列表。 名称列表中名称的顺序可能很重要，也可能不重要。 同样，这取决于使用列表的上下文。 不得使用终止空字符，既不能用于单个名称，也不能用于整个列表。

例子:

```txt
value                      representation (hex)
-----                      --------------------
(), the empty name-list    00 00 00 00
("zlib")                   00 00 00 04 7a 6c 69 62
("zlib,none")              00 00 00 09 7a 6c 69 62 2c 6e 6f 6e 65
```

----

## 算法和方法命名


SSH 协议按名称指代特定的散列、加密、完整性、压缩和密钥交换算法或方法。
有一些标准算法和方法是所有实现都必须支持的。
协议规范中还定义了一些算法和方法，但它们是可选的。
此外，预计一些组织将希望使用他们自己的算法或方法。

在此协议中，所有算法和方法标识符必须是可打印的 US-ASCII、不超过 64 个字符的非空字符串。
名称必须区分大小写。

算法和方法名称有两种格式：

不包含 at 符号 ("@") 的名称保留由 IETF CONSENSUS 分配。
示例包括“3des-cbc”、“sha-1”、“hmac-sha1”和“zlib”（双引号不是名称的一部分）。
这种格式的名称只有在首次向 IANA 注册时才有效。
注册名称不得包含 at 符号 ("@")、逗号 (",")、空格、控制字符（ASCII 代码 32 或更少）或 ASCII 代码 127 (DEL)。 名称区分大小写，并且不得超过 64 个字符。

任何人都可以通过使用 name@domainname 格式的名称来定义其他算法或方法，例如“ourcipher-cbc@example.com”。 
at 符号前部分的格式未指定； 
但是，这些名称必须是可打印的 US-ASCII 字符串，并且不得包含逗号字符 (",")、空格、控制字符（ASCII 代码 32 或更少）或 ASCII 代码 127 (DEL)。 
他们必须只有一个签名。 at-sign 后面的部分必须是由定义名称的个人或组织控制的有效、完全限定的域名 [RFC1034]。 
名称区分大小写，并且不得超过 64 个字符。 如何管理其本地命名空间取决于每个域。 
应该注意的是，这些名称类似于 STD 11 [RFC0822] 电子邮件地址。 
这纯属巧合，与 STD 11 [RFC0822] 无关。

----

## 消息编号

SSH 数据包的消息编号范围为 1 到 255。这些
编号分配如下：

传输层协议：

   1 到 19 通用传输层（例如，断开连接、忽略、调试等）
   20 到 29 算法协商
   30 到 49 特定的密钥交换方法（数字可重复用于不同的身份验证方法）

用户认证协议：

   50 到 59 用户身份验证通用
   60 到 79 特定用户验证方法（数字可重复用于不同的验证方法）

连接协议：

   80 到 89 通用连接协议
   90 到 127 通道相关消息

为客户端协议保留：

   128 到 191 保留

本地扩展：

   192 到 255 本地分机
   
   
----

## IANA 考虑事项


